[gd_resource type="BehaviorTree" load_steps=52 format=3 uid="uid://cdntafo1eagv5"]

[sub_resource type="BlackboardPlan" id="BlackboardPlan_mu0o3"]
var/hasPlank/name = &"hasPlank"
var/hasPlank/type = 1
var/hasPlank/value = false
var/hasPlank/hint = 0
var/hasPlank/hint_string = ""
var/plankInRange/name = &"plankInRange"
var/plankInRange/type = 1
var/plankInRange/value = false
var/plankInRange/hint = 0
var/plankInRange/hint_string = ""
var/wagonInRange/name = &"wagonInRange"
var/wagonInRange/type = 1
var/wagonInRange/value = false
var/wagonInRange/hint = 0
var/wagonInRange/hint_string = ""
var/hasWheelTarget/name = &"hasWheelTarget"
var/hasWheelTarget/type = 1
var/hasWheelTarget/value = false
var/hasWheelTarget/hint = 0
var/hasWheelTarget/hint_string = ""
var/wheelBroken/name = &"wheelBroken"
var/wheelBroken/type = 1
var/wheelBroken/value = false
var/wheelBroken/hint = 0
var/wheelBroken/hint_string = ""
binding/hasPlank = NodePath(".:hasPlank")
binding/plankInRange = NodePath(".:plankInRange")
binding/wagonInRange = NodePath(".:wagonInRange")
binding/hasWheelTarget = NodePath(".:hasWheelTarget")
binding/wheelBroken = NodePath(".:wheelBroken")
resource_local_to_scene = true

[sub_resource type="BBVariant" id="BBVariant_mu0o3"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_jrsvk"]
variable = &"hasPlank"
value = SubResource("BBVariant_mu0o3")

[sub_resource type="GDScript" id="GDScript_jrsvk"]
script/source = "class_name GetRandomPoint
extends BTAction

@export var patrol_radius: float = 5.0

func _tick(_delta: float) -> Status:
    if agent == null:
        return Status.FAILURE
    
    var random_offset = Vector3(
        randf_range(-patrol_radius, patrol_radius),
        0,
        randf_range(-patrol_radius, patrol_radius)
    )
    var random_point = agent.position + random_offset
    agent.set(\"targetPosition\", random_point)
    
    return Status.SUCCESS"

[sub_resource type="BTAction" id="BTAction_7s2bl"]
script = SubResource("GDScript_jrsvk")
patrol_radius = 15.0

[sub_resource type="GDScript" id="GDScript_7jdii"]
script/source = "class_name MoveTo
extends BTAction

@export var acceptance_radius: float = 1
@export var slowdown_radius: float = 2

func _tick(_delta: float) -> Status:
	if agent == null:
		return Status.FAILURE

	var current_position = agent.call(\"GetInventorySlot\").global_transform.origin #agent.global_transform.origin
	var target_position = agent.get(\"targetPosition\")
	var distance_to_target = current_position.distance_to(target_position)
	#print(\"Distance to target: \", distance_to_target)
	if distance_to_target <= acceptance_radius:
		agent.linear_velocity = Vector3.ZERO
		return Status.SUCCESS

	var speed = agent.get(\"movementSpeed\")
	if distance_to_target <= slowdown_radius:
		speed /= 2
	
	var direction = (target_position - current_position).normalized()
	var desired_velocity = direction * speed
	agent.linear_velocity = desired_velocity

	if agent.linear_velocity.length() > 0.1:
		agent.look_at(current_position + agent.linear_velocity, Vector3.UP)
		agent.rotation_degrees.x = 90

	return Status.RUNNING
"

[sub_resource type="BTAction" id="BTAction_v88ds"]
script = SubResource("GDScript_7jdii")
acceptance_radius = 1.0
slowdown_radius = 2.0

[sub_resource type="BTTimeLimit" id="BTTimeLimit_7y0tj"]
children = [SubResource("BTAction_v88ds")]

[sub_resource type="BTAlwaysSucceed" id="BTAlwaysSucceed_pak3h"]
children = [SubResource("BTTimeLimit_7y0tj")]

[sub_resource type="BTWait" id="BTWait_lsdq3"]
duration = 2.0

[sub_resource type="BTSequence" id="BTSequence_7r8yy"]
custom_name = "Patrol"
children = [SubResource("BTAction_7s2bl"), SubResource("BTAlwaysSucceed_pak3h"), SubResource("BTWait_lsdq3")]

[sub_resource type="BTSequence" id="BTSequence_mu0o3"]
custom_name = "Run Away With Plank"
children = [SubResource("BTCheckVar_jrsvk"), SubResource("BTSequence_7r8yy")]

[sub_resource type="BBVariant" id="BBVariant_gey36"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_2c5ag"]
variable = &"plankInRange"
value = SubResource("BBVariant_gey36")

[sub_resource type="BTAction" id="BTAction_1shfx"]
script = SubResource("GDScript_7jdii")
acceptance_radius = 1.0
slowdown_radius = 2.0

[sub_resource type="BTTimeLimit" id="BTTimeLimit_v88ds"]
children = [SubResource("BTAction_1shfx")]

[sub_resource type="GDScript" id="GDScript_mu0o3"]
script/source = "class_name PickupItem
extends BTAction

func _tick(_delta: float) -> Status:
	if agent == null:
		return Status.FAILURE

	if agent.call(\"PickupItem\") == true:
		return Status.SUCCESS
	else:
		return Status.FAILURE
"

[sub_resource type="BTAction" id="BTAction_rewac"]
script = SubResource("GDScript_mu0o3")

[sub_resource type="BTSequence" id="BTSequence_jrsvk"]
custom_name = "Grab Plank"
children = [SubResource("BTCheckVar_2c5ag"), SubResource("BTTimeLimit_v88ds"), SubResource("BTAction_rewac")]

[sub_resource type="BBVariant" id="BBVariant_7s2bl"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_v88ds"]
variable = &"wagonInRange"
value = SubResource("BBVariant_7s2bl")

[sub_resource type="BBVariant" id="BBVariant_7y0tj"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_pak3h"]
variable = &"hasWheelTarget"
value = SubResource("BBVariant_7y0tj")

[sub_resource type="BBVariant" id="BBVariant_v88ds"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_7y0tj"]
variable = &"hasPlank"
value = SubResource("BBVariant_v88ds")

[sub_resource type="BTRepeatUntilSuccess" id="BTRepeatUntilSuccess_pak3h"]
custom_name = "StopIfHasPlank"
children = [SubResource("BTCheckVar_7y0tj")]

[sub_resource type="BBVariant" id="BBVariant_1jble"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_gey36"]
variable = &"plankInRange"
value = SubResource("BBVariant_1jble")

[sub_resource type="BTRepeatUntilSuccess" id="BTRepeatUntilSuccess_2c5ag"]
custom_name = "StopIfPlankInRange"
children = [SubResource("BTCheckVar_gey36")]

[sub_resource type="BTAction" id="BTAction_lsdq3"]
script = SubResource("GDScript_7jdii")
acceptance_radius = 1.0
slowdown_radius = 2.0

[sub_resource type="GDScript" id="GDScript_mcitd"]
script/source = "class_name AttackWheel
extends BTAction

func _tick(_delta: float) -> Status:
    if agent == null:
        return Status.FAILURE

    if agent.call(\"AttackWheel\") == true:
        agent.apply_central_impulse(Vector3.UP * 2.5) # small jump when attacking
        return Status.SUCCESS
    else:
        return Status.FAILURE"

[sub_resource type="BTAction" id="BTAction_7r8yy"]
script = SubResource("GDScript_mcitd")

[sub_resource type="BTWait" id="BTWait_1jble"]
duration = 2.0

[sub_resource type="BBVariant" id="BBVariant_2c5ag"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_1shfx"]
variable = &"wheelBroken"
value = SubResource("BBVariant_2c5ag")

[sub_resource type="BTSequence" id="BTSequence_rewac"]
children = [SubResource("BTAction_lsdq3"), SubResource("BTAction_7r8yy"), SubResource("BTWait_1jble"), SubResource("BTCheckVar_1shfx")]

[sub_resource type="BTRepeatUntilSuccess" id="BTRepeatUntilSuccess_wxpr4"]
custom_name = "Attack"
children = [SubResource("BTSequence_rewac")]

[sub_resource type="BTParallel" id="BTParallel_7s2bl"]
children = [SubResource("BTRepeatUntilSuccess_pak3h"), SubResource("BTRepeatUntilSuccess_2c5ag"), SubResource("BTRepeatUntilSuccess_wxpr4")]

[sub_resource type="BTSequence" id="BTSequence_hmibo"]
custom_name = "Attack Wheel"
children = [SubResource("BTCheckVar_v88ds"), SubResource("BTCheckVar_pak3h"), SubResource("BTParallel_7s2bl")]

[sub_resource type="BBVariant" id="BBVariant_rewac"]
type = 1
saved_value = true
resource_name = "true"

[sub_resource type="BTCheckVar" id="BTCheckVar_wxpr4"]
variable = &"plankInRange"
value = SubResource("BBVariant_rewac")

[sub_resource type="BTRepeatUntilSuccess" id="BTRepeatUntilSuccess_hmibo"]
custom_name = "StopIfPlankInRange"
children = [SubResource("BTCheckVar_wxpr4")]

[sub_resource type="BTAction" id="BTAction_out0v"]
script = SubResource("GDScript_jrsvk")
patrol_radius = 5.0

[sub_resource type="BTAction" id="BTAction_k57rh"]
script = SubResource("GDScript_7jdii")
acceptance_radius = 1.0
slowdown_radius = 2.0

[sub_resource type="BTTimeLimit" id="BTTimeLimit_7s2bl"]
children = [SubResource("BTAction_k57rh")]

[sub_resource type="BTAlwaysSucceed" id="BTAlwaysSucceed_7s2bl"]
children = [SubResource("BTTimeLimit_7s2bl")]

[sub_resource type="BTWait" id="BTWait_xcr1a"]
duration = 2.0

[sub_resource type="BTSequence" id="BTSequence_mcitd"]
custom_name = "Patrol"
children = [SubResource("BTAction_out0v"), SubResource("BTAlwaysSucceed_7s2bl"), SubResource("BTWait_xcr1a")]

[sub_resource type="BTParallel" id="BTParallel_mbbb1"]
custom_name = "PatrolUnlessPlank"
children = [SubResource("BTRepeatUntilSuccess_hmibo"), SubResource("BTSequence_mcitd")]

[sub_resource type="BTWait" id="BTWait_7s2bl"]
custom_name = "Fail Safe Wait"

[sub_resource type="BTSelector" id="BTSelector_jrsvk"]
custom_name = "Sel - Root"
children = [SubResource("BTSequence_mu0o3"), SubResource("BTSequence_jrsvk"), SubResource("BTSequence_hmibo"), SubResource("BTParallel_mbbb1"), SubResource("BTWait_7s2bl")]

[resource]
blackboard_plan = SubResource("BlackboardPlan_mu0o3")
root_task = SubResource("BTSelector_jrsvk")
